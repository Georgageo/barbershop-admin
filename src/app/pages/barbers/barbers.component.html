<div class="space-y-6">
  <div class="flex flex-col gap-4 md:flex-row md:flex-wrap md:items-center md:justify-between">
    <div>
      <h2 class="text-2xl font-bold text-slate-800 dark:text-white">{{ 'barbers.title' | translate }}</h2>
      <p class="text-slate-600 dark:text-slate-400 mt-1">{{ 'barbers.subtitle' | translate }}</p>
    </div>
    <div class="flex items-center gap-2">
      <div class="flex rounded-xl border border-slate-200 dark:border-slate-600 overflow-hidden">
        <button
          type="button"
          (click)="setViewMode('list')"
          class="px-4 py-2 text-sm font-medium transition"
          [class]="viewMode() === 'list'
            ? 'bg-cyan-500 text-white'
            : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'"
        >
          {{ 'barbers.listView' | translate }}
        </button>
        <button
          type="button"
          (click)="setViewMode('calendar')"
          class="px-4 py-2 text-sm font-medium transition"
          [class]="viewMode() === 'calendar'
            ? 'bg-cyan-500 text-white'
            : 'bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'"
        >
          {{ 'barbers.calendarView' | translate }}
        </button>
      </div>
      @if (viewMode() === 'list') {
        <button
          type="button"
          (click)="openCreateModal()"
          class="px-4 py-2 rounded-xl bg-cyan-500 hover:bg-cyan-400 text-white font-semibold transition focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-2 dark:focus:ring-offset-slate-900"
        >
          + {{ 'barbers.addBarber' | translate }}
        </button>
      }
      <a
        routerLink="/admin/employee-hours"
        class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 font-medium transition"
      >
        {{ 'barbers.employeeHoursLink' | translate }}
      </a>
    </div>
  </div>

  @if (viewMode() === 'list') {
    @if (error() && !showCreateModal() && !showEditModal()) {
      <div class="rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-800 dark:text-red-300 px-4 py-3">
        {{ error() }}
      </div>
    }

    <div class="md:hidden">
      <app-card-list
        [data]="list()"
        [loading]="loading()"
        [emptyMessage]="'barbers.noBarbers' | translate"
        trackBy="id"
      >
        <ng-template appCardItem let-barber>
          <div class="space-y-2">
            <p class="font-semibold text-slate-800 dark:text-white">{{ displayName(barber) }}</p>
            <p class="text-sm text-slate-600 dark:text-slate-400">{{ barber.user?.email }}</p>
            @if (barber.title) {
              <p class="text-sm text-slate-500 dark:text-slate-400">{{ barber.title }}</p>
            }
            <p class="text-sm text-slate-500 dark:text-slate-400">
              {{ 'barbers.servicesCount' | translate: { count: (barber.barberServices?.length ?? 0) } }}
              ·
              <span [class]="barber.isAvailable ? 'text-green-600 dark:text-green-400 font-medium' : 'text-red-600 dark:text-red-400 font-medium'">
                {{ barber.isAvailable ? ('staff.available' | translate) : ('staff.notAvailable' | translate) }}
              </span>
            </p>
            <div class="flex flex-wrap items-center gap-2 pt-2">
              <button
                type="button"
                (click)="openEditModal(barber)"
                class="p-2 rounded-lg text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 hover:opacity-80 transition"
                [title]="'common.edit' | translate"
              >
                <i class="pi pi-pencil"></i>
              </button>
              <button
                type="button"
                (click)="toggleAvailable(barber)"
                class="p-2 rounded-lg transition hover:opacity-80"
                [class]="barber.isAvailable
                  ? 'text-green-600 dark:text-green-400'
                  : 'text-red-600 dark:text-red-400'"
                [title]="'common.toggleActive' | translate"
              >
                <i class="pi pi-power-off"></i>
              </button>
            </div>
          </div>
        </ng-template>
      </app-card-list>
    </div>

    <div class="hidden md:block">
      <app-data-table
        [data]="list()"
        [columns]="columns"
        [loading]="loading()"
        [emptyMessage]="'barbers.noBarbers' | translate"
      >
        <ng-template appTableCell="name" let-barber>{{ displayName(barber) }}</ng-template>
        <ng-template appTableCell="email" let-barber>{{ barber.user?.email ?? '—' }}</ng-template>
        <ng-template appTableCell="title" let-barber>{{ barber.title ?? '—' }}</ng-template>
        <ng-template appTableCell="details" let-barber>
          <span class="text-slate-500 dark:text-slate-400">
            {{ 'barbers.servicesCount' | translate: { count: (barber.barberServices?.length ?? 0) } }}
            ·
            <span [class]="barber.isAvailable ? 'text-green-600 dark:text-green-400 font-medium' : 'text-red-600 dark:text-red-400 font-medium'">
              {{ barber.isAvailable ? ('staff.available' | translate) : ('staff.notAvailable' | translate) }}
            </span>
          </span>
        </ng-template>
        <ng-template appTableCell="actions" let-barber>
          <div class="flex flex-wrap items-center gap-2">
            <button
              type="button"
              (click)="openEditModal(barber)"
              class="p-2 rounded-lg text-slate-600 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200 hover:opacity-80 transition"
              [title]="'common.edit' | translate"
            >
              <i class="pi pi-pencil"></i>
            </button>
            <button
              type="button"
              (click)="toggleAvailable(barber)"
              class="p-2 rounded-lg transition hover:opacity-80"
              [class]="barber.isAvailable
                ? 'text-green-600 dark:text-green-400'
                : 'text-red-600 dark:text-red-400'"
              [title]="'common.toggleActive' | translate"
            >
              <i class="pi pi-power-off"></i>
            </button>
          </div>
        </ng-template>
      </app-data-table>
    </div>

    <app-modal
      [visible]="showCreateModal()"
      [title]="'barbers.newBarber' | translate"
      [fields]="createFormFields"
      [model]="createForm"
      formId="createBarberForm"
      [errorMessage]="error()"
      (close)="closeCreateModal()"
      (submit)="saveCreate()"
    >
      <div appModalActions class="flex items-center justify-end gap-3">
        <button
          type="button"
          (click)="closeCreateModal()"
          [disabled]="saving()"
          class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 font-medium transition disabled:opacity-60"
        >
          {{ 'common.cancel' | translate }}
        </button>
        <button
          type="submit"
          [disabled]="saving()"
          form="createBarberForm"
          class="px-4 py-2 rounded-xl bg-cyan-500 hover:bg-cyan-400 text-white font-semibold transition disabled:opacity-60"
        >
          {{ saving() ? ('common.saving' | translate) : ('common.save' | translate) }}
        </button>
      </div>
    </app-modal>

    <app-modal
      [visible]="showEditModal()"
      [title]="('staff.editBarber' | translate) + ' — ' + (barberForEdit() ? displayName(barberForEdit()!) : '')"
      [fields]="editFormFields"
      [model]="editForm"
      formId="editBarberForm"
      [errorMessage]="error()"
      (close)="closeEditModal()"
      (submit)="saveEdit()"
    >
      <div appModalBody class="mt-2 pt-4 border-t border-slate-200 dark:border-slate-700">
        <p class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-3">{{ 'staff.servicesModalTitle' | translate }}</p>
        @if (editServicesLoading()) {
          <p class="text-slate-500 dark:text-slate-400 text-sm py-2">{{ 'common.loading' | translate }}</p>
        } @else {
          <ul class="space-y-2 max-h-48 overflow-y-auto">
            @for (svc of allServices(); track svc.id) {
              <li class="flex items-center gap-3 py-2 border-b border-slate-100 dark:border-slate-700 last:border-0">
                <input
                  type="checkbox"
                  [id]="'edit-svc-' + svc.id"
                  [checked]="isServiceAssigned(svc.id)"
                  (change)="toggleBarberService(svc.id)"
                  class="rounded border-slate-300 text-cyan-500 focus:ring-cyan-500"
                />
                <label [for]="'edit-svc-' + svc.id" class="flex-1 cursor-pointer text-slate-800 dark:text-slate-200 text-sm">
                  <span class="font-medium">{{ svc.name }}</span>
                  <span class="text-slate-500 dark:text-slate-400 ml-2">— {{ (svc.priceCents / 100).toFixed(2) }} €</span>
                </label>
              </li>
            } @empty {
              <p class="text-slate-500 dark:text-slate-400 text-sm py-2">{{ 'staff.noServicesAvailable' | translate }}</p>
            }
          </ul>
        }
      </div>
      <div appModalActions class="flex items-center justify-end gap-3">
        <button
          type="button"
          (click)="closeEditModal()"
          [disabled]="saving()"
          class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-300 font-medium transition disabled:opacity-60"
        >
          {{ 'common.cancel' | translate }}
        </button>
        <button
          type="submit"
          [disabled]="saving()"
          form="editBarberForm"
          class="px-4 py-2 rounded-xl bg-cyan-500 hover:bg-cyan-400 text-white font-semibold transition disabled:opacity-60"
        >
          {{ saving() ? ('common.saving' | translate) : ('common.save' | translate) }}
        </button>
      </div>
    </app-modal>
  }

  @if (viewMode() === 'calendar') {
    <div class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/50 shadow-sm overflow-hidden">
      <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex flex-wrap items-center gap-4">
        <div class="flex items-center gap-2">
          <button
            type="button"
            (click)="prevMonth()"
            class="p-2 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 transition"
            aria-label="Προηγούμενος μήνας"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
          </button>
          <span class="min-w-[180px] text-center text-lg font-semibold text-slate-800 dark:text-white capitalize">{{ calendarMonthLabel() }}</span>
          <button
            type="button"
            (click)="nextMonth()"
            class="p-2 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 transition"
            aria-label="Επόμενος μήνας"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
          </button>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm font-medium text-slate-600 dark:text-slate-400">{{ 'bookings.barber' | translate }}:</label>
          <select
            [ngModel]="calendarUserId()"
            (ngModelChange)="onCalendarUserFilterChange($event)"
            name="calendarUserFilter"
            class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-800 dark:text-white text-sm focus:ring-2 focus:ring-cyan-500 min-w-[180px]"
          >
            <option value="">{{ 'staff.all' | translate }}</option>
            @for (b of list(); track b.id) {
              <option [value]="b.userId">{{ displayName(b) }}</option>
            }
          </select>
        </div>
        <a
          routerLink="/admin/employee-hours"
          class="ml-auto text-sm text-cyan-600 dark:text-cyan-400 hover:underline"
        >
          {{ 'barbers.employeeHoursLink' | translate }}
        </a>
      </div>
      @if (calendarLoading()) {
        <div class="p-12 text-center text-slate-500 dark:text-slate-400">{{ 'common.loading' | translate }}</div>
      } @else {
        <div class="p-4 overflow-x-auto">
          <table class="w-full border-collapse calendar-table">
            <thead>
              <tr>
                @for (wd of weekDays; track wd) {
                  <th class="p-2 text-center text-xs font-semibold text-slate-600 dark:text-slate-400 border-b border-slate-200 dark:border-slate-700">{{ wd }}</th>
                }
              </tr>
            </thead>
            <tbody>
              @for (week of calendarGrid(); track week[0]?.isoDate ?? $index) {
                <tr>
                  @for (day of week; track day.isoDate) {
                    <td
                      class="align-top p-1 sm:p-2 min-w-[100px] sm:min-w-[120px] border border-slate-100 dark:border-slate-700 min-h-[100px]"
                      [class]="day.isCurrentMonth ? 'bg-white dark:bg-slate-800/50' : 'bg-slate-50 dark:bg-slate-900/50 text-slate-400 dark:text-slate-500'"
                    >
                      <div class="text-sm font-medium mb-1">{{ day.dayOfMonth }}</div>
                      <div class="space-y-1">
                        @for (entry of day.entries; track entry.userId + entry.workDate) {
                          <div class="text-xs rounded px-1.5 py-1 bg-cyan-50 dark:bg-cyan-900/20 text-slate-700 dark:text-slate-300 border border-cyan-100 dark:border-cyan-800/50">
                            <span class="font-medium">{{ employeeNameForEntry(entry) }}</span>
                            <span class="block truncate" [title]="entry.shop.name">at {{ entry.shop.name }}</span>
                            <span class="text-slate-500 dark:text-slate-400">{{ formatEntryHours(entry) }}</span>
                          </div>
                        }
                      </div>
                    </td>
                  }
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </div>
  }
</div>
